<!DOCTYPE html><html><head><script>var _hmt=_hmt||[]</script><script async src="//hm.baidu.com/hm.js?5ddf8a5814cdd65efd72825576eed605"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><meta charset="utf-8"><meta name="baidu-site-verification" content="dZ2kpxUtKy"><meta name="google-site-verification" content="googled3a0c400143e7279"><title>mysql索引优化 | 笑松小站 | 写我喜欢 读我所爱</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#3F51B5"><meta name="keywords" content="mysql索引优化"><meta name="description" content="索引概述mysql的索引数据结构主要是采用B+tree、Hash 2种。 B+tree 数据存储在叶子节点上，非叶子节点主要是起到了索引的作用，叶子节点与叶子节点之间采用双向链表的方式方便进行范围查询以及排序功能。 Hash 哈希索引使用的是哈希算法，将键值设置在hashcode对应的槽位上，如果出现哈希碰撞，采用链表进行存储。与java中HashMap数据结构类似，但是哈希索引在排序或者区间查找"><meta name="keywords" content="mysql"><meta property="og:type" content="article"><meta property="og:title" content="mysql索引优化"><meta property="og:url" content="https://peachyy.gitee.io/2023/11/10/mysql-index/index.html"><meta property="og:site_name" content="笑松小站"><meta property="og:description" content="索引概述mysql的索引数据结构主要是采用B+tree、Hash 2种。 B+tree 数据存储在叶子节点上，非叶子节点主要是起到了索引的作用，叶子节点与叶子节点之间采用双向链表的方式方便进行范围查询以及排序功能。 Hash 哈希索引使用的是哈希算法，将键值设置在hashcode对应的槽位上，如果出现哈希碰撞，采用链表进行存储。与java中HashMap数据结构类似，但是哈希索引在排序或者区间查找"><meta property="og:locale" content="zh-Hans"><meta property="og:updated_time" content="2023-11-15T06:08:06.829Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="mysql索引优化"><meta name="twitter:description" content="索引概述mysql的索引数据结构主要是采用B+tree、Hash 2种。 B+tree 数据存储在叶子节点上，非叶子节点主要是起到了索引的作用，叶子节点与叶子节点之间采用双向链表的方式方便进行范围查询以及排序功能。 Hash 哈希索引使用的是哈希算法，将键值设置在hashcode对应的槽位上，如果出现哈希碰撞，采用链表进行存储。与java中HashMap数据结构类似，但是哈希索引在排序或者区间查找"><link rel="alternative" href="/atom.xml" title="笑松小站" type="application/atom+xml"><link rel="alternative" href="/sitemap.xml" title="笑松小站" type="application/atom+xml"><meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Cache-Control" content="no-cache"><meta http-equiv="Content-Language" content="zh-CN"><meta http-equiv="Expires" content="0"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/style.css?v=1.6.7"><script>window.lazyScripts=[]</script><script data-ad-client="ca-pub-8361666066280633" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="loading" class="active"></div><div id="menu" class="hide"><ul class="reset share-icons"><li class="waves-effect waves-block" style="width:80px"><a style="color:#1ab2e8;width:45px" data-title="Home" class="" href="/"><i class="icon icon-home"></i> Home</a></li><li class="waves-effect waves-block" style="width:80px"><a style="color:#1ab2e8;width:45px" data-title="Archives" class="" href="/archives"><i class="icon icon-archives"></i> Archives</a></li><li class="waves-effect waves-block" style="width:80px"><a style="color:#1ab2e8;width:45px" data-title="Tags" class="" href="/tags"><i class="icon icon-tags"></i> Tags</a></li><li class="waves-effect waves-block" style="width:80px"><a style="color:#1ab2e8;width:45px" data-title="About" class="" href="/guestbook"><i class="icon icon-book"></i> About</a></li><li class="waves-effect waves-block" style="width:80px"><a style="color:#1ab2e8;width:45px" data-title="Links" class="" href="/links"><i class="icon icon-links"></i> Links</a></li></ul></div><main id="main"><header class="top-header" id="header"><div class="flex-row"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle"><i class="icon icon-lg icon-navicon"></i></a> <a href="/" class="header-icon avatar waves-effect waves-circle waves-light"><img src="/img/avatar.jpg"></a><div class="flex-col header-title ellipsis">mysql索引优化</div><div class="search-wrap" id="search-wrap"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back"><i class="icon icon-lg icon-chevron-left"></i></a> <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search"><i class="icon icon-lg icon-search"></i></a></div><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare"><i class="icon icon-lg icon-share-alt"></i></a></div></header><header class="content-header post-header"><div class="container fade-scale"><h1 class="title">mysql索引优化</h1><h5 class="subtitle"> <time datetime="2023-11-09T16:00:00.000Z" itemprop="datePublished" class="page-time">2023-11-10</time><ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/技术/">技术</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/技术/mysql/">mysql</a></li></ul></li></ul></h5></div></header><div class="container body-wrap"><aside class="post-widget"><nav class="post-toc-wrap" id="post-toc"><h4>TOC</h4><ol class="post-toc"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#索引概述"><span class="post-toc-text">索引概述</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#索引的分类"><span class="post-toc-text">索引的分类</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#启用慢SQL"><span class="post-toc-text">启用慢SQL</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#启用Mysql-Profiling"><span class="post-toc-text">启用Mysql Profiling</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#explain-语句执行性能分析"><span class="post-toc-text">explain 语句执行性能分析</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#explain结果中id执行顺序"><span class="post-toc-text">explain结果中id执行顺序</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#联合索引"><span class="post-toc-text">联合索引</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#覆盖索引"><span class="post-toc-text">覆盖索引</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#前缀索引"><span class="post-toc-text">前缀索引</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#SQL语句预定义SQL索引指示"><span class="post-toc-text">SQL语句预定义SQL索引指示</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#索引设计原则"><span class="post-toc-text">索引设计原则</span></a></li></ol></nav></aside><article id="post-mysql-index" class="post-article article-type-post fade" itemprop="blogPost"><div class="post-card"><h1 class="post-card-title">mysql索引优化</h1><div class="post-meta"> <time class="post-time" title="2023年11月10日 0:00" datetime="2023-11-09T16:00:00.000Z" itemprop="datePublished">2023-11-10</time><ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/技术/">技术</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/技术/mysql/">mysql</a></li></ul></li></ul><span id="busuanzi_container_page_pv" title="文章总阅读量" style="display:none"><i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span></span></div><div class="post-content" id="post-content" itemprop="postContent"><h4 id="索引概述"><a href="#索引概述" class="headerlink" title="索引概述"></a>索引概述</h4><p>mysql的索引数据结构主要是采用B+tree、Hash 2种。</p><p>B+tree 数据存储在叶子节点上，非叶子节点主要是起到了索引的作用，叶子节点与叶子节点之间采用双向链表的方式方便进行范围查询以及排序功能。</p><p>Hash 哈希索引使用的是哈希算法，将键值设置在hashcode对应的槽位上，如果出现哈希碰撞，采用链表进行存储。与java中HashMap数据结构类似，但是哈希索引在排序或者区间查找等场景可能会让SQL变得更慢。</p><p>创建索引语句格式如下</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> 索引名称 <span class="keyword">on</span> 表名(字段名); <span class="comment">-- 创建一个单列索引</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> 索引名称 <span class="keyword">on</span> 表名(字段名,字段名,字段名);<span class="comment">-- 创建联合索引/多列索引</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> 索引名称 <span class="keyword">on</span> 表名(字段名 排序规则<span class="keyword">asc</span> | <span class="keyword">desc</span>); <span class="comment">-- 创建一个索引 并指定排序规则、</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> 索引名称 <span class="keyword">on</span> 表名(列名(长度)) ;<span class="comment">-- 创建前缀索引</span></span><br></pre></td></tr></table></figure><h4 id="索引的分类"><a href="#索引的分类" class="headerlink" title="索引的分类"></a>索引的分类</h4><p>从索引的存储形式上分为：</p><ul><li>聚集索引<br>索引和整行数据(Row)存储在一起，每一行数据有且只有一个。默认情况主键索引就是聚集索引，没有主键索引的情况下，第一个唯一索引就是聚集索引，如果唯一索引也没有,mysql默认会生成一个隐藏的rowId作为聚集索引。查询走到聚集是不需要回表操作，所以性能很高。</li><li>二级索引<br>非聚集索引为二级索引，将数据和索引分开存储，二级索引只对应了数据行的主键，一张表可以多个这样的索引，需要回表操作。</li></ul><p>按类型区分主要分为:</p><ul><li><p>主键索引 primary 只能有1个</p></li><li><p>唯一索引 unique 可以有多个</p></li><li><p>普通索引 常规的hash、 b+tree索引</p></li><li><p>全文索引 Mysql用得比较少 主要是用来全文搜索</p></li><li>联合索引 多个字段组合成一个索引 比较常用</li></ul><p>如何在mysql中查看各个语句操作的执行频率次数呢？</p><p>通过 show GLOBAL status like ‘Com_______’语句能查看各个操作的次数，此指令能看到数据库中主要以查询为主还是更新为主</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; show GLOBAL status like 'Com_______';</span><br><span class="line">+<span class="comment">---------------+-------+</span></span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+<span class="comment">---------------+-------+</span></span><br><span class="line">| Com_binlog    | 0     |</span><br><span class="line">| Com_commit    | 6     |</span><br><span class="line">| Com_delete    | 14    |</span><br><span class="line">| Com_insert    | 509   |</span><br><span class="line">| Com_repair    | 0     |</span><br><span class="line">| Com_revoke    | 0     |</span><br><span class="line">| Com_select    | 2319  |</span><br><span class="line">| Com_signal    | 0     |</span><br><span class="line">| Com_update    | 38    |</span><br><span class="line">| Com_xa_end    | 0     |</span><br><span class="line">+<span class="comment">---------------+-------+</span></span><br><span class="line">10 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h4 id="启用慢SQL"><a href="#启用慢SQL" class="headerlink" title="启用慢SQL"></a>启用慢SQL</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">slow_query_log= on 开启慢查询日志</span><br><span class="line">slow_query_log_file = /opt/mysqlslow.log <span class="comment">#慢查询日志文件</span></span><br><span class="line">long_query_time= 4 <span class="comment">#指定多少时间后为慢查询 4秒为慢查询 默认为10秒</span></span><br></pre></td></tr></table></figure><p>针对慢查询优化是处理SQL优化的重要手段，查看慢sql日志文件 /opt/mysqlslow.log就能看到系统中慢sql的执行情况，找到了慢SQL就可以着手进行优化。</p><h4 id="启用Mysql-Profiling"><a href="#启用Mysql-Profiling" class="headerlink" title="启用Mysql Profiling"></a>启用Mysql Profiling</h4><p>Profiling是5.0之后的版本才被支持的特性。但是又在mysql5.7之后，mysql推荐使用performance schema</p><p>使用@@have_profiling变量查看当前数据库是否支持profiling。如下返回YES证明支持。</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; select @@have_profiling;</span><br><span class="line">+<span class="comment">------------------+</span></span><br><span class="line">| @@have_profiling |</span><br><span class="line">+<span class="comment">------------------+</span></span><br><span class="line">| YES              |</span><br><span class="line">+<span class="comment">------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>使用流程大致如下</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">set profiling=1; #打开分析统计开关</span><br><span class="line"><span class="meta">#</span><span class="bash"> select * from user;执行你的任何SQL语句</span></span><br><span class="line">show profiles;</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show profiles; <span class="comment"># 能看到上面语句的执行时间</span></span></span><br><span class="line">+----------+------------+--------------------+</span><br><span class="line">| Query_ID | Duration   | Query              |</span><br><span class="line">+----------+------------+--------------------+</span><br><span class="line">|        1 | 0.00024075 | select * from user |</span><br><span class="line">+----------+------------+--------------------+</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show profile <span class="keyword">for</span> query 1; <span class="comment"># 查看queryid为1的更详细的性能分析</span></span></span><br><span class="line">+----------------------+----------+</span><br><span class="line">| Status               | Duration |</span><br><span class="line">+----------------------+----------+</span><br><span class="line">| starting             | 0.000064 |</span><br><span class="line">| checking permissions | 0.000007 |</span><br><span class="line">| Opening tables       | 0.000018 |</span><br><span class="line">| init                 | 0.000023 |</span><br><span class="line">| System lock          | 0.000007 |</span><br><span class="line">| optimizing           | 0.000004 |</span><br><span class="line">| statistics           | 0.000012 |</span><br><span class="line">| preparing            | 0.000010 |</span><br><span class="line">| executing            | 0.000003 |</span><br><span class="line">| Sending data         | 0.000049 |</span><br><span class="line">| end                  | 0.000006 |</span><br><span class="line">| query end            | 0.000007 |</span><br><span class="line">| closing tables       | 0.000007 |</span><br><span class="line">| freeing items        | 0.000015 |</span><br><span class="line">| cleaning up          | 0.000010 |</span><br><span class="line">+----------------------+----------+</span><br><span class="line">15 rows in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="explain-语句执行性能分析"><a href="#explain-语句执行性能分析" class="headerlink" title="explain 语句执行性能分析"></a>explain 语句执行性能分析</h4><p>在mysql中explain应该是使用频次最多，最为重要的性能分析工具。</p><p>语法 explain ‘sql语句’。如：</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; explain select * from user;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------+</span></span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------+</span></span><br><span class="line">|  1 | SIMPLE      | user  | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    1 |   100.00 | NULL  |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><table><thead><tr><th>字段</th><th>含义</th></tr></thead><tbody><tr><td>id</td><td>id表示执行顺序 值越大越先执行，值相同从上往下的顺序执行</td></tr><tr><td>select_type</td><td>查询类型<br> simple：表示不需要union操作或者不包含子查询的简单select查询。有连接查询时，外层的查询为simple，且只有一个<br> primary：一个需要union操作或者含有子查询的select，位于最外层的单位查询的select_type即为primary。 且只有一个<br> union：union连接的两个select查询，第一个查询是dervied派生表，除了第一个表外，第二个以后的表 select_type都是union<br>dependent union：与union一样，出现在union 或union all语句中，但是这个查询要受到外部查询的影响<br>union result：包含union的结果集，在union和union all语句中,因为它不需要参与查询，所以id字段为null<br>subquery：除了from字句中包含的子查询外，其他地方出现的子查询都可能是subquery<br>dependent subquery：与dependent union类似，表示这个subquery的查询要受到外部表查询的影响<br>derived：from字句中出现的子查询，也叫做派生表，其他数据库中可能叫做内联视图或嵌select</td></tr><tr><td>table</td><td>表名 有别名的时候显示的是别名</td></tr><tr><td>partitions</td><td>分区 主要是针对分区表才会有显示此字段</td></tr><tr><td>type</td><td>访问类型 性能优化的重要指标，从高到低顺序为system -&gt; const -&gt; eq_ref -&gt; ref -&gt; range -&gt; index -&gt;ALL<br>const: 当使用主键或者唯一索引查询时会出现const<br>ref 使用非唯一性索引会出现ref<br>range 当使用范围查询索引的时候会出现range<br>all 全表扫描 需要优化</td></tr><tr><td>possible_keys</td><td>可能会用到的索引</td></tr><tr><td>key</td><td>实际用到的索引，如果是联合索引这里是显示用到了多个索引的列表 逗号分隔</td></tr><tr><td>key_len</td><td>key的长度</td></tr><tr><td>ref</td><td>如果是使用的常数等值查询，这里会显示const，如果是连接查询，被驱动表的执行计划这里会显示驱动表的关联字段，如果是条件使用了表达式或者函数，或者条件列发生了内部隐式转换，这里可能显示为func</td></tr><tr><td>rows</td><td>根据表预估统计行数及索引选用情况，估算的找到所需的记录所需要读取的行数，值越小越好</td></tr><tr><td>filtered</td><td>被过滤的比例 值越大性能越好</td></tr><tr><td>Extra</td><td>mysql执行语句额外信息<br>Using index：该值表示相应的select操作中使用了覆盖索引（Covering Index）<br>Using where：表示MySQL服务器在存储引擎收到(使用索引)记录后进行“后过滤”<br>Using temporary：表示MySQL需要使用临时表来存储结果集，常见于排序和分组查询<br>Using filesort： MySQL中无法利用索引完成的排序操作称为“文件排序”，常见于order by和group by语句中</td></tr></tbody></table><p>创建2张测试表 user、score来简单的测试一下索引规则</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`sex`</span> <span class="built_in">int</span>(<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`age`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="keyword">now</span>(),</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`name_idx`</span> (<span class="string">`name`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`age_idx`</span> (<span class="string">`age`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`create_time_idx`</span> (<span class="string">`create_time`</span>)    </span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`score`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`course`</span> <span class="built_in">varchar</span>(<span class="number">68</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`score`</span> <span class="keyword">double</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`user_id_idx`</span> (<span class="string">`user_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入user表</span></span><br><span class="line"> <span class="keyword">insert</span> <span class="keyword">user</span> (<span class="keyword">name</span>,sex,age) <span class="keyword">values</span>(<span class="string">'a1'</span>,<span class="number">1</span>,<span class="number">10</span>),(<span class="string">'a2'</span>,<span class="number">0</span>,<span class="number">11</span>),(<span class="string">'a3'</span>,<span class="number">0</span>,<span class="number">13</span>),(<span class="string">'a4'</span>,<span class="number">1</span>,<span class="number">15</span>),(<span class="string">'a5'</span>,<span class="number">1</span>,<span class="number">16</span>),(<span class="string">'a6'</span>,<span class="number">0</span>,<span class="number">17</span>),(<span class="string">'a7'</span>,<span class="number">1</span>,<span class="number">18</span>),(<span class="string">'a8'</span>,<span class="number">0</span>,<span class="number">19</span>),(<span class="string">'a9'</span>,<span class="number">0</span>,<span class="number">20</span>),(<span class="string">'a10'</span>,<span class="number">1</span>,<span class="number">21</span>),(<span class="string">'a11'</span>,<span class="number">0</span>,<span class="number">22</span>);</span><br><span class="line"><span class="comment">-- 插入score表</span></span><br><span class="line"><span class="keyword">insert</span> score (course,score,user_id) <span class="keyword">values</span>(<span class="string">'语文'</span>,<span class="number">99</span>,<span class="number">1</span>),(<span class="string">'数学'</span>,<span class="number">60</span>,<span class="number">1</span>),(<span class="string">'英语'</span>,<span class="number">89</span>,<span class="number">1</span>),(<span class="string">'物理'</span>,<span class="number">78</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure><h5 id="explain结果中id执行顺序"><a href="#explain结果中id执行顺序" class="headerlink" title="explain结果中id执行顺序"></a>explain结果中id执行顺序</h5><p>根据用户name=a1查询成绩表</p><p>explain select * from score where user_id = (select id from user where name=’a1’);</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+----------+---------+-------+------+----------+-------------+</span></span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key      | key_len | ref   | rows | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+----------+---------+-------+------+----------+-------------+</span></span><br><span class="line">|  1 | PRIMARY     | score | NULL       | ALL  | user_id_idx   | NULL     | NULL    | NULL  |    4 |   100.00 | Using where |</span><br><span class="line">|  2 | SUBQUERY    | user  | NULL       | ref  | name_idx      | name_idx | 153     | const |    1 |   100.00 | Using index |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+----------+---------+-------+------+----------+-------------+</span></span><br></pre></td></tr></table></figure><p>可以看到user表的id为2， score表的id为1。说明user要需要先执行 然后再执行user表。事实也是如此，有子查询的情况，理论上也是需要先执行子查询。</p><p><a href="/2023/11/15/mysql-explain/">更多explain参考 explain详解</a></p><h4 id="联合索引"><a href="#联合索引" class="headerlink" title="联合索引"></a>联合索引</h4><p>联合索引也叫多列索引 也是比较常用且非常实用的索引。联合索引遵循最左匹配原则，也就是联合索引中最左边的字段必须存在，一级一级的查找，中间不能跨列，依次向右匹配。下面为user表中创建一个由字段name,age,sex组成的联合索引。</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">user</span> <span class="keyword">drop</span> <span class="keyword">index</span> name_idx; <span class="comment">-- 删除索引 </span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">user</span> <span class="keyword">drop</span> <span class="keyword">index</span> age_idx;  <span class="comment">-- 删除索引  </span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> name_age_sex <span class="keyword">on</span> <span class="keyword">user</span> (<span class="keyword">name</span>,age,sex);</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">index</span> <span class="keyword">from</span> <span class="keyword">user</span>;<span class="comment">-- 查看索引列表</span></span><br></pre></td></tr></table></figure><p>explain select * from user where sex=1 and name=’a1’ and age=11 ;</p><p>explain select * from user where name=’a1’ and age=11 and sex=1;</p><p>以上2语句都能成功使用到完整的索引，说明索引在查找的时候和语句的条件顺序没有太大关系，主要是要遵循创建联合索引的最左原则就行。</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">+<span class="comment">-------+------------+------+---------------+--------------+---------+-------------------+------+----------+-------------+</span></span><br><span class="line">| table | partitions | type | possible_keys | key          | key_len | ref               | rows | filtered | Extra       |</span><br><span class="line">+<span class="comment">-------+------------+------+---------------+--------------+---------+-------------------+------+----------+-------------+</span></span><br><span class="line">| user  | NULL       | ref  | name_age_sex  | name_age_sex | 163     | const,const,const |    1 |   100.00 | Using index |</span><br><span class="line">+<span class="comment">-------+------------+------+---------------+--------------+---------+-------------------+------+----------+-------------+</span></span><br></pre></td></tr></table></figure><p> explain select * from user where age=11 ;</p><p> 该语句中由于没有遵循最左匹配原则，直接加了一个age，实际没有使用到联合索引</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">+<span class="comment">-------+-------+---------------+--------------+---------+------+------+----------+--------------------------+</span></span><br><span class="line">| table | type  | possible_keys | key          | key_len | ref  | rows | filtered | Extra                    |</span><br><span class="line">+<span class="comment">-------+-------+---------------+--------------+---------+------+------+----------+--------------------------+</span></span><br><span class="line">| user  | index | NULL          | NULL         | NULL    | NULL |   11 |    10.00 | Using where;             |</span><br><span class="line">+<span class="comment">-------+-------+---------------+--------------+---------+------+------+----------+--------------------------+</span></span><br></pre></td></tr></table></figure><p> explain select * from user where name=’a1’ and age&gt;10 and sex=1;</p><p>该语句中使用了联合索引的前2个字段索引，最后一个sex并没有使用到，是因为age&gt;10语句执行之后 后面的条件就不继续查找索引。同理还有小于&lt;也是一样。</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">+<span class="comment">-------+------------+-------+---------------+--------------+---------+------+------+----------+--------------------------+</span></span><br><span class="line">| table | partitions | type  | possible_keys | key          | key_len | ref  | rows | filtered | Extra                    |</span><br><span class="line">+<span class="comment">-------+------------+-------+---------------+--------------+---------+------+------+----------+--------------------------+</span></span><br><span class="line">| user  | NULL       | range | name_age_sex  | name_age_sex | 158     | NULL |    1 |    10.00 | Using index condition    |</span><br><span class="line">+<span class="comment">-------+------------+-------+---------------+--------------+---------+------+------+----------+--------------------------+</span></span><br></pre></td></tr></table></figure><p>explain select * from user where name=’a1’ and age&gt;=10 and sex=1;</p><p>和上一步语句中<code>&gt;</code>符变为了<code>&gt;=</code> 能看到结果中key_len变长了 走到3个字段的索引。足以证明&gt;后面的字段不走索引，那么&gt;=却走到了索引。</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">+<span class="comment">-------+------------+-------+---------------+--------------+---------+------+------+----------+--------------------------+</span></span><br><span class="line">| table | partitions | type  | possible_keys | key          | key_len | ref  | rows | filtered | Extra                    |</span><br><span class="line">+<span class="comment">-------+------------+-------+---------------+--------------+---------+------+------+----------+--------------------------+</span></span><br><span class="line">| user  | NULL       | range | name_age_sex  | name_age_sex | 163     | NULL |    1 |    10.00 | Using index condition    |</span><br><span class="line">+<span class="comment">-------+------------+-------+---------------+--------------+---------+------+------+----------+--------------------------+</span></span><br></pre></td></tr></table></figure><p>总结一下索引失效的部分案例，失效的部分场景实在是太多了。</p><ol><li>联合索引的时候 没有按照最左匹配<br> 如上面的示例中 explain select * from user where age=11 ;</li><li>字段值类型传递错误 如varchar 不加’ ‘号 导致出现隐式类型转换，在高版本的mysql又是生效的</li><li>字段上写函数 如date_format等 不走索引</li><li><code>&gt;</code>号后面的条件 不走索引,&gt;=可以走 同理 <code>&lt;</code>号后面的条件不走索引,&lt;=走索引</li><li>or 后字段如果没有索引会导致有索引的where，不走索引</li><li>数据分布 评估，如果走索引的时候数据反而更多，mysql就不会走索引</li><li>is not null ，is null 也会走数据分布评估逻辑,如果数据量null不多，那么is not null 不走。</li></ol><h4 id="覆盖索引"><a href="#覆盖索引" class="headerlink" title="覆盖索引"></a>覆盖索引</h4><p>覆盖索引是指查询使用了索引，并且需要返回的列，在该索引中已经全部能够找到 ，就不需要回表操作，如果查询的列在索引中找不到那么mysql就会进行回表操作。所以查询的时候应该尽可能的使用覆盖索引，减少select * 这样的查询方式。</p><p>当用explain 分析的时候 Extra出现如下 using index condition表示进行了回表。</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">using index condition <span class="comment">-- 使用了索引 但是进行了回表查询</span></span><br></pre></td></tr></table></figure><p>没有回表操作的样例</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">using where</span><br><span class="line">using index <span class="comment">-- 查找使用索引。select的字段都有索引 不需要回标查询</span></span><br></pre></td></tr></table></figure><h4 id="前缀索引"><a href="#前缀索引" class="headerlink" title="前缀索引"></a>前缀索引</h4><p>前缀索引主要是针对文本字段如longtext、text、varchar 之类的类型创建索引，如果只是对大字段创建索引可能造成索引非常大，查询与存储都浪费IO，影响查询性能，前缀索引正好可以解决这个问题，可以对文本前多少个字符创建索引，这样就避免了全部文本创建索引。这样既优化了存储大小，也优化了查询IO的问题，使用此索引方式需要具体看业务场景是否可以允许只搜索前多少字符这样的需求。</p><p>创建前缀索引格式如下:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> 索引名称 <span class="keyword">on</span> 表名(字段名(长度));</span><br></pre></td></tr></table></figure><h4 id="SQL语句预定义SQL索引指示"><a href="#SQL语句预定义SQL索引指示" class="headerlink" title="SQL语句预定义SQL索引指示"></a>SQL语句预定义SQL索引指示</h4><p> 主要分为预置SQL语句，指定索引、忽略索引、强制索引。但是这里只是向mysql推荐，至于最终是不是使用这个索引 需要数据库引擎最终判断。</p><ul><li><p>use index 建议语句指定sql使用指定索引</p><p> explain select * from score use index(user_idx) where user_id=1;</p></li><li><p>ignore index 忽略语句不使用指定索引<br> explain select * from score ignore index(user_id_idx) where user_id=3;</p></li><li><p>force index 强制语句使用指定索引<br>explain select * from score force index(user_id_idx) where user_id=3;</p></li></ul><h4 id="索引设计原则"><a href="#索引设计原则" class="headerlink" title="索引设计原则"></a>索引设计原则</h4><ul><li><p>数据量大 且查询频繁的建议索引</p></li><li><p>where， order by ，groupby建立索引</p></li><li><p>字符串太长 可以考虑前缀索引</p></li><li><p>选择区分度高的字段创建索引</p></li><li><p>区分度不高的字段可以不建索引 如性别 永远只有男、女</p></li><li><p>多字段查询尽量使用联合索引、select字段尽量使用覆盖索引 避免回表</p></li><li><p>如果索引列不为NULL 建议字段设置NOT NULL。对mysql索引优化器有好处</p></li><li>索引不要建的太多，满足查询需求就好，太多会影响insert update delete这些更新语句的性能，多硬盘也不友好，会占用大量存储</li></ul></div><blockquote class="post-copyright"><div class="content"> <span class="post-time">最后更新时间：<time datetime="2023-11-15T06:08:06.829Z" itemprop="dateUpdated">2023年11月15日 14:08</time></span><br> 转载请注明文章出处：转载至笑松小站<a href="/2023/11/10/mysql-index/" target="_blank" rel="external">https://peachyy.gitee.io/2023/11/10/mysql-index/</a></div><footer> <a href="https://peachyy.gitee.io"><img src="/img/avatar.jpg" alt="peachyy"> peachyy</a></footer></blockquote><div> <span>评论需要<a href="/fq/">翻墙</a> 点击 <a href="/fq">此处</a>轻松免费翻墙 也可以关注公众号<笑笑笑技术圈>联系到我 会不定期发布一些不限于技术的文章</笑笑笑技术圈></span><br> <img src="/img/wxgzh.jpg" style="vertical-align:middle;width:30%;height:20%;margin-left:30%" alt="笑笑笑技术圈"></div><div class="page-reward"> <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a></div><div class="post-footer"><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/">mysql</a></li></ul><div class="page-share-wrap"><div class="page-share" id="pageShare"><ul class="reset share-icons"><li><a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://peachyy.gitee.io/2023/11/10/mysql-index/&title=《mysql索引优化》 — 笑松小站" data-title="微博"><i class="icon icon-weibo"></i></a></li><li><a class="weixin share-sns wxFab" href="javascript:;" data-title="微信"><i class="icon icon-weixin"></i></a></li><li><a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://peachyy.gitee.io/2023/11/10/mysql-index/&title=《mysql索引优化》 — 笑松小站&source=个人博客,陶小松,陶小松的博客,重庆陶小松,java,hoaoop,redis,笑松,笑松小站,笑松的小站,笑松博客,笑松的博客,小松的网络日志,技术博客..." data-title=" QQ"><i class="icon icon-qq"></i></a></li><li><a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://peachyy.gitee.io/2023/11/10/mysql-index/" data-title=" Facebook"><i class="icon icon-facebook"></i></a></li><li><a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《mysql索引优化》 — 笑松小站&url=https://peachyy.gitee.io/2023/11/10/mysql-index/&via=https://peachyy.gitee.io" data-title=" Twitter"><i class="icon icon-twitter"></i></a></li><li><a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://peachyy.gitee.io/2023/11/10/mysql-index/" data-title=" Google+"><i class="icon icon-google-plus"></i></a></li></ul></div><a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle"><i class="icon icon-share-alt icon-lg"></i></a></div></div></div><nav class="post-nav flex-row flex-justify-between"><div class="waves-block waves-effect prev"><a href="/2023/11/15/mysql-explain/" id="post-prev" class="post-nav-link"><div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div><h4 class="title">mysql explain详解</h4></a></div><div class="waves-block waves-effect next"><a href="/2023/08/02/jetbrains-chinese/" id="post-next" class="post-nav-link"><div class="tips">Next<i class="icon icon-angle-right icon-lg icon-pl"></i></div><h4 class="title">idea汉化教程 jetbrains系列工具DataGrip PyCharm WebStorm Intellij IDEA Goland clion 汉化教程</h4></a></div></nav><link rel="stylesheet" href="//unpkg.com/gitalk/dist/gitalk.css"><script src="//unpkg.com/gitalk/dist/gitalk.min.js"></script><div id="gitalk-container"></div><script>
	var tagArr=[];
	
		
			tagArr.push('mysql');
		
	
	function regitalk(pathname){
		if(pathname.length>50){
			return pathname.substr(0,50)
		}
		return pathname
	}
	const gitalk = new Gitalk({
	  clientID: '162446b5ba25df668cca',
	  clientSecret: '236645cfe80a3cf91a226e41a909b774e74e7710',
	  repo: 'peach-comment-rep',
	  owner: 'peachframe',
	  admin: ['970815940','peachyy'],
	  distractionFreeMode: false,
	  id: regitalk(location.pathname),
	  labels :tagArr,
	  title: 'mysql索引优化',
	  proxy: 'https://proxy.cors.sh/https://github.com/login/oauth/access_token',
	})
	gitalk.render('gitalk-container')
</script></article><div id="reward" class="page-modal reward-lay"><a class="close" href="javascript:;"><i class="icon icon-close"></i></a><h3 class="reward-title"><i class="icon icon-quote-left"></i> 谢谢大爷~<i class="icon icon-quote-right"></i></h3><ul class="reward-items"><li> <img src="/img/wechat.jpg" title="微信打赏二维码" alt="微信打赏二维码"><p>微信</p></li><li> <img src="/img/alipay.jpg" title="支付宝打赏二维码" alt="支付宝打赏二维码"><p>支付宝</p></li></ul></div></div><footer class="footer"><div class="top" style="color:#fff"><p> <span id="busuanzi_container_site_uv" style="display:none">站点总访客数：<span id="busuanzi_value_site_uv"></span></span> <span id="busuanzi_container_site_pv" style="display:none">站点总访问量：<span id="busuanzi_value_site_pv"></span></span></p><p><span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span> <span>博客内容遵循 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0协议</a></span></p></div><div class="bottom" style="color:#fff"><p> <span>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></span> <span>笑松小站 &copy; 2015 - 2023</span></p></div></footer></main><div class="mask" id="mask"></div><a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a><div class="global-share" id="globalShare"><ul class="reset share-icons"><li><a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://peachyy.gitee.io/2023/11/10/mysql-index/&title=《mysql索引优化》 — 笑松小站" data-title="微博"><i class="icon icon-weibo"></i></a></li><li><a class="weixin share-sns wxFab" href="javascript:;" data-title="微信"><i class="icon icon-weixin"></i></a></li><li><a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://peachyy.gitee.io/2023/11/10/mysql-index/&title=《mysql索引优化》 — 笑松小站&source=个人博客,陶小松,陶小松的博客,重庆陶小松,java,hoaoop,redis,笑松,笑松小站,笑松的小站,笑松博客,笑松的博客,小松的网络日志,技术博客..." data-title=" QQ"><i class="icon icon-qq"></i></a></li><li><a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://peachyy.gitee.io/2023/11/10/mysql-index/" data-title=" Facebook"><i class="icon icon-facebook"></i></a></li><li><a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《mysql索引优化》 — 笑松小站&url=https://peachyy.gitee.io/2023/11/10/mysql-index/&via=https://peachyy.gitee.io" data-title=" Twitter"><i class="icon icon-twitter"></i></a></li><li><a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://peachyy.gitee.io/2023/11/10/mysql-index/" data-title=" Google+"><i class="icon icon-google-plus"></i></a></li></ul></div><div class="page-modal wx-share" id="wxShare"><a class="close" href="javascript:;"><i class="icon icon-close"></i></a><p>扫一扫，分享到微信</p> <img src="//api.qrserver.com/v1/create-qr-code/?data=https://peachyy.gitee.io/2023/11/10/mysql-index/" alt="微信分享二维码"></div><script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script><script>var BLOG={ROOT:"/",SHARE:!0,REWARD:!0}</script><script src="/js/main.js?v=1.6.7"></script><div class="search-panel" id="search-panel"><ul class="search-result" id="search-result"></ul></div><template id="search-tpl"><li class="item"><a href="{path}" class="waves-block waves-effect"><div class="title ellipsis" title="{title}">{title}</div><div class="flex-row flex-middle"><div class="tags ellipsis"> {tags}</div> <time class="flex-col time">{date}</time></div></a></li></template><script src="/js/search.js?v=1.6.7" async></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>